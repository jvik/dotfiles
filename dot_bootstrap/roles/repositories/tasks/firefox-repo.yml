---
- name: Configure Firefox repository for Ubuntu
  when: ansible_distribution == 'Ubuntu'
  block:
    - name: Install gpg if not present
      ansible.builtin.package:
        name: gpg
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Mozilla repository key
      ansible.builtin.get_url:
        url: https://packages.mozilla.org/apt/repo-signing-key.gpg
        dest: /tmp/mozilla-repo-signing-key.gpg
        mode: '0644'

    - name: Install Mozilla repository key
      ansible.builtin.shell: |
        set -o pipefail
        gpg --dearmor < /tmp/mozilla-repo-signing-key.gpg | tee /etc/apt/keyrings/packages.mozilla.org.gpg > /dev/null
      args:
        executable: /bin/bash
      changed_when: false

    - name: Create Mozilla deb822 sources file
      ansible.builtin.copy:
        content: |
          Types: deb
          URIs: https://packages.mozilla.org/apt
          Suites: mozilla
          Components: main
          Signed-By: /etc/apt/keyrings/packages.mozilla.org.gpg
        dest: /etc/apt/sources.list.d/mozilla.sources
        owner: root
        group: root
        mode: '0644'

    - name: Set Mozilla repository priority
      ansible.builtin.copy:
        content: |
          Package: firefox*
          Pin: origin packages.mozilla.org
          Pin-Priority: 1001
        dest: /etc/apt/preferences.d/mozilla
        owner: root
        group: root
        mode: '0644'

    - name: Allow unattended upgrades for Mozilla repository
      ansible.builtin.copy:
        content: |
          Unattended-Upgrade::Origins-Pattern { "archive=mozilla"; };
        dest: /etc/apt/apt.conf.d/51unattended-upgrades-firefox
        owner: root
        group: root
        mode: '0644'

    - name: Remove Firefox snap installation
      ansible.builtin.command:
        cmd: snap remove firefox
      register: repositories_snap_remove_result
      failed_when:
        - repositories_snap_remove_result.rc != 0
        - '"not installed" not in repositories_snap_remove_result.stderr'
        - '"No such file or directory" not in repositories_snap_remove_result.stderr'
      changed_when: repositories_snap_remove_result.rc == 0
