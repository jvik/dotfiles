---
- name: Add vscode native repo
  when: ansible_distribution == 'Fedora'
  block:
    - name: Import Microsoft GPG Key
      ansible.builtin.rpm_key:
        key: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add Visual Studio Code Repo
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        gpgcheck: true
        enabled: true

- name: Configure Firefox repository for Ubuntu
  when: ansible_distribution == 'Ubuntu'
  block:
    - name: Install gpg if not present
      ansible.builtin.package:
        name: gpg
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Mozilla repository key
      ansible.builtin.get_url:
        url: https://packages.mozilla.org/apt/repo-signing-key.gpg
        dest: /tmp/mozilla-repo-signing-key.gpg
        mode: '0644'

    - name: Install Mozilla repository key
      ansible.builtin.shell: |
        set -o pipefail
        gpg --dearmor < /tmp/mozilla-repo-signing-key.gpg | tee /etc/apt/keyrings/packages.mozilla.org.gpg > /dev/null
      args:
        executable: /bin/bash
      changed_when: false

    - name: Create Mozilla deb822 sources file
      ansible.builtin.copy:
        content: |
          Types: deb
          URIs: https://packages.mozilla.org/apt
          Suites: mozilla
          Components: main
          Signed-By: /etc/apt/keyrings/packages.mozilla.org.gpg
        dest: /etc/apt/sources.list.d/mozilla.sources
        owner: root
        group: root
        mode: '0644'

    - name: Set Mozilla repository priority
      ansible.builtin.copy:
        content: |
          Package: firefox*
          Pin: origin packages.mozilla.org
          Pin-Priority: 1001
        dest: /etc/apt/preferences.d/mozilla
        owner: root
        group: root
        mode: '0644'

    - name: Allow unattended upgrades for Mozilla repository
      ansible.builtin.copy:
        content: |
          Unattended-Upgrade::Origins-Pattern { "archive=mozilla"; };
        dest: /etc/apt/apt.conf.d/51unattended-upgrades-firefox
        owner: root
        group: root
        mode: '0644'

    - name: Remove Firefox snap installation
      ansible.builtin.command:
        cmd: snap remove firefox
      register: repositories_snap_remove_result
      failed_when:
        - repositories_snap_remove_result.rc != 0
        - '"not installed" not in repositories_snap_remove_result.stderr'
        - '"No such file or directory" not in repositories_snap_remove_result.stderr'
      changed_when: repositories_snap_remove_result.rc == 0

- name: Configure RPM Fusion repositories
  when: ansible_distribution == 'Fedora'
  block:
    - name: Importing RPM Fusion (free) key
      ansible.builtin.rpm_key:
        state: present
        key: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-free-fedora-2020

    - name: Importing RPM Fusion (non-free) key
      ansible.builtin.rpm_key:
        state: present
        key: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-nonfree-fedora-2020

    - name: Enable the RPM Fusion repository
      ansible.builtin.dnf:
        name: 'https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm'
        state: present

    - name: Enable RPM Fusion Nonfree repository
      ansible.builtin.dnf:
        name: 'https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm'
        state: present
