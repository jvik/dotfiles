---
- name: Install multiple packages
  hosts: localhost
  become: true
  gather_facts: true
  vars_files:
    - ~/.bootstrap/vars.yml
  tasks:
    # - name: Ensure community.general collection is installed and up-to-date
    #   ansible.builtin.command:
    #     cmd: ansible-galaxy collection install community.general --upgrade
    #   become: false
    #   changed_when: false

    - name: Add vscode native repo
      when: ansible_distribution == 'Fedora'
      block:
        - name: Import Microsoft GPG Key
          ansible.builtin.rpm_key:
            key: https://packages.microsoft.com/keys/microsoft.asc
            state: present

        - name: Add Visual Studio Code Repo
          ansible.builtin.yum_repository:
            name: vscode
            description: Visual Studio Code
            baseurl: https://packages.microsoft.com/yumrepos/vscode
            gpgkey: https://packages.microsoft.com/keys/microsoft.asc
            gpgcheck: true
            enabled: true

    - name: Configure RPM Fusion and install Fedora-specific packages
      when: ansible_distribution == 'Fedora'
      block:
        - name: Importing RPM Fusion (free) key
          ansible.builtin.rpm_key:
            state: present
            key: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-free-fedora-2020

        - name: Importing RPM Fusion (non-free) key
          ansible.builtin.rpm_key:
            state: present
            key: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-nonfree-fedora-2020

        - name: Enable the RPM Fusion repository
          ansible.builtin.dnf:
            name: 'https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm'
            state: present

        - name: Enable RPM Fusion Nonfree repository
          ansible.builtin.dnf:
            name: 'https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm'
            state: present

        # - name: Install wezterm
        #   community.general.copr:
        #     name:
        #       - 'wezfurlong/wezterm-nightly'
        #     state: enabled

        - name: Install Fedora specific packages
          ansible.builtin.package:
            name:
              - 'NetworkManager-tui'
            state: present

    - name: Install packages
      ansible.builtin.package:
        name:
          - fd-find
          - tree
          - flatpak
          - ansible-lint
          - htop
          - blueman
          - unrar
          - zsh
          - git
          - neovim
          - code
          - playerctl
          - copyq
        state: present
        update_cache: true

    - name: Install sway packages
      ansible.builtin.package:
        name:
          - sway
          - wofi
          - SwayNotificationCenter
          - waybar
      when: window_manager == "sway"

    - name: Add Flathub remote
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
        method: system

    - name: Install Flatpak packages
      community.general.flatpak:
        name:
          - org.videolan.VLC
          - com.bitwarden.desktop/x86_64/stable
          - com.fastmail.Fastmail/x86_64/stable
          - com.github.tchx84.Flatseal/x86_64/stable
          - com.mattjakeman.ExtensionManager/x86_64/stable
          - com.mikrotik.WinBox/x86_64/stable
          - com.plexamp.Plexamp/x86_64/stable
          - com.saivert.pwvucontrol/x86_64/stable
          - dev.vencord.Vesktop/x86_64/stable
          - md.obsidian.Obsidian/x86_64/stable
        state: present

    - name: Check if Homebrew is already installed
      ansible.builtin.stat:
        path: '/home/linuxbrew/.linuxbrew/bin/brew'
      register: brew_stat

    - name: Install and configure Homebrew
      block:
        - name: Check if HomeBrew is installed
          become: false
          ansible.builtin.stat:
            path: /home/linuxbrew/.linuxbrew/bin/brew
          register: brew

        - name: Download & Install HomeBrew
          become: false
          when: not brew.stat.exists
          block:
            - name: Create tmp dir
              ansible.builtin.file:
                path: '/home/{{ user }}/temp'
                state: directory
                mode: '0755'
            - name: Download Installer Script
              ansible.builtin.get_url:
                url: https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh
                dest: /home/{{ user }}/temp/brew_install.sh
                mode: '775'
            - name: Run Installer Script
              ansible.builtin.command: /home/{{ user }}/temp/brew_install.sh
              environment:
                NONINTERACTIVE: '1'
              changed_when: true

        - name: Set LinuxBrew Executable Path
          ansible.builtin.set_fact:
            linuxbrew_executable: /home/linuxbrew/.linuxbrew/bin/brew
            linuxbrew_path: /home/linuxbrew/.linuxbrew/bin

    - name: Set user shell to zsh
      ansible.builtin.user:
        name: '{{ user }}'
        shell: /bin/zsh
      become: true

    - name: Check if oh my zsh is already installed
      ansible.builtin.stat:
        path: '/home/{{ user }}/.oh-my-zsh'
      register: oh_my_zsh_stat

    - name: Install oh-my-zsh
      when: not oh_my_zsh_stat.stat.exists
      block:
        - name: Install Oh-My-Zsh
          ansible.builtin.git:
            repo: https://github.com/ohmyzsh/ohmyzsh.git
            dest: /home/{{ user }}/.oh-my-zsh
            version: 'master'
            clone: true
            update: true

    - name: Install Homebrew packages and casks
      environment:
        PATH: '/home/linuxbrew/.linuxbrew/bin:{{ ansible_env.PATH }}'
      block:
        - name: Install Homebrew packages
          become: false
          community.general.homebrew:
            name:
              - ctop
              - eza
              - fzf
              - atuin
              - gh
              - just
              - neofetch
              - tfenv
              - uv
              - zoxide
              - zsh-autosuggestions
              - zsh-syntax-highlighting
              - kubectl
              - kubectx
              - k9s
            state: present

          # - name: Install homebrew extras for sway
          #   become: false
          #   community.general.homebrew:
          #     name:
          #       - waylock
          #     state: present
          #   when: window_manager == "sway"

        - name: Install homebrew casks
          become: false
          community.general.homebrew_cask:
            name:
              - font-fontawesome
              - font-jetbrains-mono
              - font-jetbrains-mono-nerd-font
            state: present
